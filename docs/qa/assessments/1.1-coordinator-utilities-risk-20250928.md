# Story 1.1 Risk Profile — Coordinator Utilities (2025-09-28)

## Summary

Coordinator utilities introduce parallel execution to the tool pipeline. Primary risks stem from concurrency races affecting ordered results, incomplete abort propagation, and insufficient test coverage for timing-sensitive paths. Overall risk rating is **High** because two high-severity technical/operational risks remain until mitigation and tests land.

## Overall Risk Score

- Base Score: 100
- Deductions: 2 × High (−20), 1 × Medium (−5)
- **Calculated Score:** 75 / 100 (High)

## Risk Matrix

| Risk ID  | Description                                                                                              | Probability | Impact     | Score | Priority |
| -------- | -------------------------------------------------------------------------------------------------------- | ----------- | ---------- | ----- | -------- |
| TECH-001 | Scheduler races break ordered aggregation or duplicate hook emissions under parallel load.               | Medium (2)  | High (3)   | 6     | High     |
| OPS-001  | Abort signal not propagated reliably, leaving hanging tool invocations and UI inconsistencies.           | Medium (2)  | High (3)   | 6     | High     |
| PERF-001 | Misconfigured concurrency cap saturates provider rate limits, degrading wall-time and hitting throttles. | Low (1)     | Medium (2) | 2     | Low      |
| QA-001   | Missing deterministic unit tests produce flaky regressions in concurrency and abort scenarios.           | Medium (2)  | Medium (2) | 4     | Medium   |

## Detailed Risk Register

| Risk ID  | Category          | Affected Components                                                | Detection Method                                                | Mitigation Strategy                                                                                          | Owner           | Status  |
| -------- | ----------------- | ------------------------------------------------------------------ | --------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ | --------------- | ------- |
| TECH-001 | Technical         | `executeToolCallsInParallel`, hooks, downstream result aggregation | Architecture review surfaced need for pump ordering guarantees. | Enforce index-aligned storage, single writer per index, and add tests for staggered latencies.               | Dev Agent       | Open    |
| OPS-001  | Operational       | Abort handling, hook cleanup, telemetry spans                      | Research validation highlighted need for guard rails.           | Add `signal.throwIfAborted()` checks before dispatch, unregister listeners, assert no hooks fire post-abort. | Dev Agent       | Open    |
| PERF-001 | Performance       | Concurrency cap configuration, feature flag defaults               | Config review noted cap is user-configurable.                   | Clamp cap 1..10, document defaults, add telemetry alert if configured above 6.                               | Dev Agent & Ops | Planned |
| QA-001   | Quality Assurance | Jest unit suite for coordinator                                    | Lack of dedicated concurrency-focused tests.                    | Implement deterministic fake-timer-based tests covering ordering, errors, abort, cap edges.                  | QA + Dev        | Open    |

## Risk-Based Testing Strategy

1. **Critical/High (TECH-001, OPS-001)**
   - Add unit tests that simulate staggered completions, error propagation, and abort races using fake timers.
   - Run chaos-style tests with randomized failure/timeout sequences to ensure deterministic ordering.
2. **Medium (QA-001)**
   - Expand Jest coverage to verify hook invocation counts and EventEmitter cleanup.
   - Include integration test for both runners once coordinator is integrated (future story).
3. **Low (PERF-001)**
   - Add config-driven test ensuring caps clamp correctly and telemetry records actual concurrency.

## Deployment & Monitoring Recommendations

- Keep feature flag default `parallelToolCalls.enabled=false` until coordinator passes regression suite.
- Emit latency, concurrency, and abort metrics to existing observability dashboards; create alert when abort ratio >10% over 5m.
- Document manual rollback toggle in runbook for on-call engineers.

## Quality Gate Recommendation

- **Gate Status:** CONCERNS — Block release until TECH-001 and OPS-001 mitigations complete with tests.
- **Next Review Trigger:** After coordinator utilities land in main branch with passing tests and telemetry instrumentation captured.

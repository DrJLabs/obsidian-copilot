# Story 1.3 Risk Profile — Copilot+ Integration & Telemetry (2025-09-29)

## Summary

Copilot+ now inherits the parallel coordinator, ActionBlock/ThinkBlock streaming, and telemetry hooks introduced for Autonomous runs. The dominant risk is that streaming markers or partial-response plumbing degrade when the coordinator rewires tool execution. Secondary risks center on preserving localSearch formatting, keeping telemetry lightweight, and guaranteeing the feature flag still gates parallelism. Overall risk rating is **Medium** with a High-priority streaming risk that must be mitigated before enabling the flag for Plus cohorts.

## Overall Risk Score

- Base Score: 100
- Deductions: 1 × High (−10), 1 × Medium (−5), 2 × Low (−4)
- **Calculated Score:** 81 / 100 (Medium)

## Risk Matrix

| Risk ID  | Description                                                                                                                                  | Probability | Impact     | Score | Priority |
| -------- | -------------------------------------------------------------------------------------------------------------------------------------------- | ----------- | ---------- | ----- | -------- |
| TECH-201 | Coordinator hookup breaks ActionBlock/ThinkBlock streaming, causing duplicate or missing tool markers and partial responses.                 | Medium (2)  | High (3)   | 6     | High     |
| TECH-202 | LocalSearch aggregation loses byte-identical formatting or citation hints when coordinator results feed Copilot+ post-processing.            | Medium (2)  | Medium (2) | 4     | Medium   |
| PERF-201 | Telemetry spans or summary logging double-emits for every tool, inflating wall time or flooding observability backends.                      | Low (1)     | Medium (2) | 2     | Low      |
| OPS-201  | Feature flag or concurrency clamp fails, enabling parallel Copilot+ execution when disabled or outside 1..10, bypassing rollback safeguards. | Low (1)     | Medium (2) | 2     | Low      |

## Detailed Risk Register

| Risk ID  | Category    | Affected Components                                                                                            | Detection Method                                                                                           | Mitigation Strategy                                                                                                                 | Owner           | Status |
| -------- | ----------- | -------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- | --------------- | ------ |
| TECH-201 | Technical   | `CopilotPlusChainRunner`, `ActionBlockStreamer`, `executeCoordinatorFlow`, `ThinkBlockStreamer`                | Pending Copilot+ integration tests exercising mixed visible/background tools with streaming.               | Add integration suites that compare sequential vs parallel streaming output and enforce marker parity before rollout.               | Dev Agent + QA  | Open   |
| TECH-202 | Technical   | `processLocalSearchResult`, `prepareEnhancedUserMessage`, citation assembly                                    | Existing sequential regression snapshots; new coordinator path lacks parity coverage for Copilot+ outputs. | Implement sequential/parallel snapshot comparison focused on localSearch-only turns and ensure unit guards for formatter utilities. | QA Team         | Open   |
| PERF-201 | Performance | Telemetry emitters (`emitToolSpan`), `[parallel] execution summary` logging, monitoring pipeline               | Autonomous runner telemetry already instrumented; Copilot+ integration widens span volume.                 | Extend benchmark harness to measure span count + duration deltas; gate rollout on ≤10% overhead and add alerts for span spikes.     | Dev Agent + SRE | Open   |
| OPS-201  | Operational | Feature flag plumbing (`parallelToolCalls.enabled`), concurrency clamp (`resolveParallelToolConfig`), fallback | Shared resolver exists but Copilot+ currently bypasses coordinator; regression possible during refactor.   | Unit-test clamp logic in Copilot+ wrapper, integration-test sequential fallback, and surface config mismatches in summary logs.     | Dev Agent + Ops | Open   |

## Risk-Based Testing Strategy

1. **High Priority (TECH-201)**

   - Execute integration tests that stream mixed foreground/background tools through Copilot+ with feature flag on; assert `onStart`/`onSettle` markers and partial responses remain in order.  
     _Sources: docs/architecture/6-runner-integration.md#62-copilot, src/LLMProviders/chainRunner/utils/parallelExecution.ts_
   - Add sequential vs parallel golden-output comparisons for prompt/context assembly to catch streaming or ActionBlock regressions.  
     _Sources: docs/prd/8-acceptance-criteria.md, docs/architecture/11-backward-compatibility.md_

2. **Medium Priority (TECH-202)**

   - Cover localSearch-only flows to ensure coordinator results still feed `prepareEnhancedUserMessage` and citations without duplication.  
     _Sources: src/LLMProviders/chainRunner/CopilotPlusChainRunner.ts_
   - Guard `processLocalSearchResult` with unit tests around XML wrapping and source deduplication when results arrive via coordinator payloads.

3. **Low Priority (PERF-201, OPS-201)**
   - Benchmark telemetry spans/log output pre/post integration; assert overhead stays within Architecture §9 performance targets.  
     _Sources: docs/architecture/8-observability.md, docs/architecture/9-performance-targets.md_
   - Validate feature flag fallbacks (disabled flag, out-of-range concurrency) and abort pathways under coordinator to maintain rollback safety.  
     _Sources: docs/architecture/7-config-feature-flags.md, docs/architecture/5-coordinator-design.md#53-error-timeout-cancel_

## Risk Mitigation Recommendations

- Treat TECH-201 as release-blocking: land Copilot+ streaming integration tests before flag enablement; require QA sign-off on sequential vs parallel snapshots.
- Extend existing telemetry dashboards to split Autonomous vs Copilot+ span volume so Perf regressions surface quickly.
- Document feature flag fallback expectations in runbooks and ensure `[parallel] execution summary` logs include the active cap/flag state for auditing.

## Monitoring & Review

- Track `tool.start`/`tool.settle` span counts and latency histograms per runner once Copilot+ integration is merged.
- Revisit this risk profile after initial Copilot+ rollout metrics to adjust probabilities and retire mitigated risks.

---

Risk profile: docs/qa/assessments/1.3-copilot-plus-integration-risk-20250929.md

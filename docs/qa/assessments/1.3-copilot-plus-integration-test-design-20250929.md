# Test Design: Story 1.3 — Copilot+ Integration & Telemetry

Date: 2025-09-29
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 11
- By level: Unit 4 (36%), Integration 6 (55%), E2E 1 (9%)
- Priority distribution: P0 6, P1 4, P2 1, P3 0
- Tooling: Jest with fake timers and mocked ToolManager calls, msw-based tool stubs for Copilot+ runner, snapshot harness for prompt/context parity, telemetry assertion helpers capturing `emitToolSpan` output, and optional CLI harness for Copilot+ streaming smoke tests.

## Test Scenarios by Acceptance Criteria

### AC1: Coordinator hooks preserve marker behavior

| ID           | Level       | Priority | Test                                                                                                                                          | Justification                                                                                          |
| ------------ | ----------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| 1.3-UNIT-001 | Unit        | P0       | Validate Copilot+ helper builds coordinator call metadata (background flag, temporary IDs) before invoking `executeCoordinatorFlow`.          | Ensures foreground/background markers remain aligned when refactoring the sequential loop (Arch §6.2). |
| 1.3-INT-001  | Integration | P0       | Run mixed-latency foreground/background tools through Copilot+ with flag enabled; assert `onStart`/`onSettle` markers match sequential order. | Detects TECH-201 regressions impacting ActionBlock/ThinkBlock streaming.                               |
| 1.3-INT-002  | Integration | P1       | Stream partial responses while tools settle; verify ActionBlock + ThinkBlock outputs remain identical to sequential execution.                | Guards against partial-response drift introduced by coordinator scheduling.                            |

### AC2: Ordered results feed aggregation unchanged

| ID           | Level       | Priority | Test                                                                                                                                     | Justification                                                                                |
| ------------ | ----------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- |
| 1.3-INT-003  | Integration | P0       | Compare sequential versus parallel Copilot+ runs (same tool stubs) and assert prompt/context strings and memory payloads are byte-equal. | Prevents TECH-202 by enforcing Architecture §11 backward-compatibility guarantees.           |
| 1.3-UNIT-002 | Unit        | P1       | Unit-test `processLocalSearchResult` / aggregation helpers to confirm coordinator `ToolResult` payloads are wrapped once with citations. | Protects localSearch formatting and source deduplication flow.                               |
| 1.3-INT-004  | Integration | P1       | Execute localSearch-only turn through coordinator; verify QA-format response and citations remain intact.                                | Validates acceptance criteria for citation parity when only background search results exist. |

### AC3: Telemetry spans and summary logging

| ID           | Level       | Priority | Test                                                                                                                                                                                                                         | Justification                                                             |
| ------------ | ----------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- |
| 1.3-UNIT-003 | Unit        | P0       | Assert Copilot+ coordinator wrapper emits `tool.start` / `tool.settle` spans with index, duration, concurrency, and status metadata.                                                                                         | Covers FR10 telemetry requirements with fast feedback.                    |
| 1.3-INT-005  | Integration | P2       | Measure span count and `[parallel] execution summary` log once per turn; fail if duplicates appear or overhead exceeds 10% vs sequential (**implemented via `parallelExecution.test.ts` telemetry assertions, 2025-09-29**). | Addresses PERF-201 by bounding telemetry overhead per Architecture §§8–9. |

### AC4: Feature flag, abort, and fallback safeguards

| ID           | Level       | Priority | Test                                                                                                                                       | Justification                                                                  |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------ |
| 1.3-UNIT-004 | Unit        | P0       | Verify `resolveParallelToolConfig` usage in Copilot+ wrapper: cap <1 or >10 triggers sequential fallback, disabled flag skips coordinator. | Enforces OPS-201 mitigations while keeping configuration centralized.          |
| 1.3-INT-006  | Integration | P0       | Abort mid-flight using `AbortController`; ensure no post-abort marker updates while final results still log for diagnostics.               | Confirms Architecture §5.3 abort semantics remain intact with the coordinator. |
| 1.3-E2E-001  | E2E         | P1       | CLI harness turn toggling feature flag during execution; validate fallback path, telemetry spans, and final response remain consistent.    | Provides end-to-end assurance before widening rollout per Architecture §13.    |

## Risk Coverage Mapping

| Test ID      | Mitigates Risks    |
| ------------ | ------------------ |
| 1.3-UNIT-001 | TECH-201, OPS-201  |
| 1.3-INT-001  | TECH-201           |
| 1.3-INT-002  | TECH-201           |
| 1.3-INT-003  | TECH-201, TECH-202 |
| 1.3-UNIT-002 | TECH-202           |
| 1.3-INT-004  | TECH-202           |
| 1.3-UNIT-003 | PERF-201           |
| 1.3-INT-005  | PERF-201           |
| 1.3-UNIT-004 | OPS-201            |
| 1.3-INT-006  | TECH-201, OPS-201  |
| 1.3-E2E-001  | TECH-201, OPS-201  |

## Recommended Execution Order

1. P0 unit and integration suites (`1.3-UNIT-001`, `1.3-INT-001`, `1.3-INT-003`, `1.3-UNIT-003`, `1.3-UNIT-004`, `1.3-INT-006`).
2. P1 streaming, localSearch, and CLI coverage (`1.3-INT-002`, `1.3-UNIT-002`, `1.3-INT-004`, `1.3-E2E-001`).
3. P2 telemetry regression benchmark (`1.3-INT-005`) — implemented via jest span-duration assertions.

## Coverage Gaps & Notes

- No acceptance criteria remain uncovered; telemetry benchmark is optional for early iterations but required before flag enablement.
- Favor fake timers for integration suites to keep concurrency deterministic and avoid flakiness in streaming assertions.

---

Test design matrix: docs/qa/assessments/1.3-copilot-plus-integration-test-design-20250929.md
P0 tests identified: 6

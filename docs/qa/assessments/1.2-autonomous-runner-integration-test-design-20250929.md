# Test Design: Story 1.2 — Autonomous Runner Integration

Date: 2025-09-29
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 10
- By level: Unit 3 (30%), Integration 6 (60%), E2E 1 (10%)
- Priority distribution: P0 5, P1 4, P2 1, P3 0
- Tooling: Jest with fake timers and deferred promises, snapshot harness for prompt/context parity, msw-based tool stubs, optional CLI harness for end-to-end validation.

## Test Scenarios by Acceptance Criteria

### AC1: Markers mirror sequential flow

| ID           | Level       | Priority | Test                                                                                                                        | Justification                                                             |
| ------------ | ----------- | -------- | --------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- |
| 1.2-UNIT-001 | Unit        | P0       | `parallelExecution.test.ts` verifies marker updates for foreground tools and background suppression via coordinator helper. | Protects UI semantics without needing full runner harness.                |
| 1.2-INT-001  | Integration | P0       | Exercise runner with mixed-latency visible/background tools; assert `onStart`/`onSettle` markers in order.                  | Ensures hook wiring preserves UI semantics mandated in Architecture §6.1. |
| 1.2-UNIT-003 | Unit        | P1       | Verify background tools are pre-registered without visible markers and skip UI updates.                                     | Guards against regressions where background tools leak UI markers.        |

### AC2: Ordered results feed into `processToolResults`

| ID          | Level       | Priority | Test                                                                                                 | Justification                                                                              |
| ----------- | ----------- | -------- | ---------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------ |
| 1.2-INT-002 | Integration | P0       | Compare coordinator-fed runner output vs sequential path to ensure identical prompt/context strings. | Prevents TECH-102 by validating aggregation parity with Architecture §6 and §11 contracts. |
| 1.2-INT-003 | Integration | P1       | Snapshot final assistant payloads (messages, memory) for mixed tool sequences.                       | Detects unintended formatting drift beyond string equality (e.g., metadata ordering).      |

### AC3: Feature flag + concurrency clamp

| ID           | Level       | Priority | Test                                                                                                      | Justification                                                 |
| ------------ | ----------- | -------- | --------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------- |
| 1.2-UNIT-002 | Unit        | P0       | Clamp `parallelToolCalls.concurrency` inputs (<1, >10) and assert sequential fallback when flag disabled. | Enforces OPS-102 mitigation per Architecture §7 guidance.     |
| 1.2-INT-004  | Integration | P1       | Toggle feature flag at runtime and ensure runner reverts to sequential execution without stale markers.   | Confirms safe fallback behavior across configuration changes. |

### AC4: Abort, timeout, and error reuse

| ID          | Level       | Priority | Test                                                                                                                                  | Justification                                                                             |
| ----------- | ----------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| 1.2-INT-005 | Integration | P0       | Trigger `AbortController` mid-flight within coordinator helper; ensure UI markers do not update post-abort and cancellation captured. | Mitigates TECH-102/QA-102 by validating abort propagation described in Architecture §5.3. |
| 1.2-E2E-001 | E2E         | P1       | Run CLI harness with feature flag enabled to ensure abort and timeout telemetry still appear in logs.                                 | Validates real runner behavior and logging continuity under production-like flow.         |
| 1.2-INT-006 | Integration | P2       | Measure span counts before/after integration to confirm observability hooks do not double-emmit.                                      | Addresses PERF-102 monitoring concerns from Architecture §8.                              |

## Risk Coverage Mapping

| Test ID      | Mitigates Risks  |
| ------------ | ---------------- |
| 1.2-INT-001  | TECH-102         |
| 1.2-INT-002  | TECH-102         |
| 1.2-INT-003  | TECH-102         |
| 1.2-UNIT-002 | OPS-102          |
| 1.2-INT-004  | OPS-102, QA-102  |
| 1.2-INT-005  | TECH-102, QA-102 |
| 1.2-E2E-001  | QA-102           |
| 1.2-INT-006  | PERF-102         |
| 1.2-UNIT-001 | QA-102           |
| 1.2-UNIT-003 | QA-102           |

## Recommended Execution Order

1. P0 unit/integration suites (`1.2-INT-001`, `1.2-INT-002`, `1.2-UNIT-002`, `1.2-INT-005`).
2. P1 regression suites covering fallback, background markers, and E2E harness (`1.2-UNIT-003`, `1.2-INT-003`, `1.2-INT-004`, `1.2-E2E-001`).
3. P2 telemetry regression check (`1.2-INT-006`).

## Coverage Gaps & Notes

- None. All acceptance criteria mapped to at least one scenario; critical risks addressed by automated coverage.
- Ensure integration suites stub provider latency deterministically (fake timers) to avoid flaky parallel timing.

---

Test design matrix: docs/qa/assessments/1.2-autonomous-runner-integration-test-design-20250929.md
P0 tests identified: 5

# Test Design: Story 1.1 — Coordinator Utilities

Date: 2025-09-28
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 9
- By level: Unit 6 (67%), Integration 2 (22%), E2E 1 (11%)
- Priority distribution: P0 4, P1 4, P2 1, P3 0
- Tooling: Jest with fake timers, Node AbortController, msw mocks for tool calls

## Test Scenarios by Acceptance Criteria

### AC1: `executeToolCall` wraps existing single-call logic

| ID           | Level | Priority | Test                                                                            | Justification                                                        |
| ------------ | ----- | -------- | ------------------------------------------------------------------------------- | -------------------------------------------------------------------- |
| 1.1-UNIT-001 | Unit  | P0       | Returns ToolResult with normalized payload/error identical to sequential helper | Critical single-call invariants; pure function around existing logic |
| 1.1-UNIT-002 | Unit  | P1       | Propagates gating/timeouts by delegating to sequential pathway                  | Ensures no regression in gating behavior without external deps       |

### AC2: `executeToolCallsInParallel` concurrency cap & options

| ID           | Level       | Priority | Test                                                                    | Justification                                             |
| ------------ | ----------- | -------- | ----------------------------------------------------------------------- | --------------------------------------------------------- |
| 1.1-UNIT-003 | Unit        | P0       | Respects default concurrency=4 and clamps inputs <1 or >10              | Prevents PERF-001 misconfiguration impact                 |
| 1.1-INT-001  | Integration | P1       | Scheduler launches new tasks as slots free with mixed duration promises | Validates bounded parallelism with controlled fake timers |

### AC3: Ordered results & hook lifecycle

| ID           | Level       | Priority | Test                                                                      | Justification                                    |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------- | ------------------------------------------------ |
| 1.1-UNIT-004 | Unit        | P0       | Writes results by input index, ignoring completion order                  | Guards against TECH-001 ordering regressions     |
| 1.1-INT-002  | Integration | P1       | `onStart`/`onSettle` fire once per call for foreground/background markers | Ensures UI markers stable and telemetry accurate |

### AC4: Abort, timeout, error reuse

| ID           | Level | Priority | Test                                                                       | Justification                 |
| ------------ | ----- | -------- | -------------------------------------------------------------------------- | ----------------------------- |
| 1.1-UNIT-005 | Unit  | P0       | `signal.aborted` prevents additional launches and throws cancellation      | Stops races causing OPS-001   |
| 1.1-UNIT-006 | Unit  | P1       | Errors map to existing statuses (`error`,`timeout`) and still settle hooks | Ensures logging compatibility |

### AC5: Unit-test coverage requirements

| ID          | Level | Priority | Test                                                                                    | Justification                                     |
| ----------- | ----- | -------- | --------------------------------------------------------------------------------------- | ------------------------------------------------- |
| 1.1-E2E-001 | E2E   | P2       | Synthetic CLI harness executes mixed tool types to confirm deterministic ordered output | Provides high-level regression before flag enable |

## Risk Coverage Mapping

| Test ID      | Mitigates Risks   |
| ------------ | ----------------- |
| 1.1-UNIT-003 | PERF-001          |
| 1.1-UNIT-004 | TECH-001          |
| 1.1-INT-002  | TECH-001          |
| 1.1-UNIT-005 | OPS-001           |
| 1.1-UNIT-006 | OPS-001, QA-001   |
| 1.1-E2E-001  | TECH-001, OPS-001 |

## Recommended Execution Order

1. P0 unit tests (1.1-UNIT-001,003,004,005)
2. P0 integration test (1.1-INT-001)
3. Remaining P1 unit/integration tests (1.1-UNIT-002,006, 1.1-INT-002)
4. P2 E2E harness (1.1-E2E-001) prior to enabling feature flag

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 9
  by_level:
    unit: 6
    integration: 2
    e2e: 1
  by_priority:
    p0: 4
    p1: 4
    p2: 1
    p3: 0
  coverage_gaps: []
```

## Trace References

```
Test design matrix: docs/qa/assessments/1.1-coordinator-utilities-test-design-20250928.md
P0 tests identified: 4
```

## Quality Checklist

- [x] Every AC has explicit coverage
- [x] Test levels chosen using Test Levels Framework
- [x] Priorities derived from Test Priorities Matrix
- [x] No duplicated logic across levels beyond defense-in-depth on P0 risks
- [x] IDs follow `{epic}.{story}-{LEVEL}-{SEQ}` naming
- [x] Scenarios independent and automatable

## 🔬 Research & Validation Log (2025-09-28)

- **Researcher:** Researcher Agent
- **Active Mode:** solo
- **Primary Artifact:** docs/qa/assessments/1.1-coordinator-utilities-test-design-20250928.md
- **Summary:** Validated concurrency-focused test plan; reinforced abort listener cleanup and deterministic fake-timer workflows to limit flake risk when enabling parallel scheduler tests.citeturn0search0turn0search2turn1search1turn1search8

### Findings & Actions

| Priority | Area                  | Recommended Change                                                                                                                                                | Owner / Reviewer | Confidence | Mode | Controls          | Evidence Location                                                     | Sources                          |
| -------- | --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------- | ---------- | ---- | ----------------- | --------------------------------------------------------------------- | -------------------------------- |
| High     | Abort Safety Coverage | Add explicit test that aborts mid-flight, asserts listener disposal, and verifies `AbortSignal` listener cleanup so no handlers remain after cancellation.        | Dev Agent / QA   | High       | solo | OWASP ASVS 5.2.4  | docs/qa/assessments/1.1-coordinator-utilities-test-design-20250928.md | citeturn0search0turn0search2 |
| Medium   | Fake Timer Robustness | Introduce shared helper to advance timers while flushing microtasks (`runOnlyPendingTimers` plus promise drains) to avoid hangs noted in Jest fake-timer reports. | QA / Dev Agent   | Medium     | solo | OWASP ASVS 9.1.2  | docs/qa/assessments/1.1-coordinator-utilities-test-design-20250928.md | citeturn1search1turn1search8 |
| Medium   | Performance Watch     | Track concurrency test runtimes and rerun-orders in CI to detect emerging order-dependent flakes before enabling the flag by default.                             | Dev Agent        | Medium     | solo | OWASP ASVS 10.3.1 | docs/qa/assessments/1.1-coordinator-utilities-test-design-20250928.md | citeturn1academia12           |

### Tooling Guidance

- **FOSS-first Recommendation:** Extend Jest fake-timer utilities with custom `flushMicrotasks()` or switch to `@sinonjs/fake-timers` when needing async `tickAsync`.citeturn1search8
- **Paid Option (if required):** None required; existing OSS tooling satisfies needs.
- **Automation / Scripts:** Add `npm run test:coord-scheduler` wrapper executing unit + integration suites with `--runInBand` and microtask flush helper to surface ordering issues early.citeturn1academia12

### Risk & Compliance Notes

- **Residual Risks:** Medium — fake timers plus promises can still hide race conditions; periodically rerun suites with real timers to confirm behavior.citeturn1search8
- **Compliance / Control Mapping:** Supports ASVS 5.2.4 (safe interruption) and 9.1.2 (deterministic execution) via abort cleanup and deterministic tests.citeturn0search0turn1search1
- **Monitoring / Observability:** Capture test duration + failure causes in CI dashboards; alert on >5% variance week-over-week to catch flakes linked to scheduler changes.citeturn1academia12
- **Rollback / Contingency:** Revert to sequential tool execution tests if concurrency suite shows persistent order-dependent flake signatures.citeturn1academia12

### Follow-Up Tasks

- [x] Implement abort cleanup test and shared AbortController helper — Owner: Dev Agent, Due: 2025-10-05
- [x] Add microtask flushing utility to concurrency test harness — Owner: QA Agent, Due: 2025-10-05

### Source Appendix

1. Node.js Events API — `AbortSignal` listener guidance (accessed 2025-09-28).citeturn0search0
2. Node.js issue #51010 documenting abort listener leak regressions (accessed 2025-09-28).citeturn0search2
3. Testing Library fake timer hygiene notes (accessed 2025-09-28).citeturn1search1
4. Jest feature request on async fake timer APIs (accessed 2025-09-28).citeturn1search8
5. JS-TOD study on Jest order-dependent flakes (accessed 2025-09-28).citeturn1academia12
